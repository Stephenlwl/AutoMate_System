<!-- Main Chat Container -->
<div class="dashboard-content d-flex h-90">
  <!-- Channel List Sidebar -->
  <div class="channels-sidebar bg-light border-end" style="width: 350px; min-width: 350px;">
    <div class="sidebar-header p-3 border-bottom">
      <h3 class="h5 mb-3">
        <i class="bi bi-chat me-2 text-primary"></i>Chat List {{totalChannels > 0 ? '(' + totalChannels + ' channels)' : ''}}
      </h3>
      <div class="filter-tabs nav nav-pills nav-fill gap-2">
        <button class="nav-link flex-fill" [class.active]="selectedFilter === 'all'" (click)="filterChannels('all')">
          All
        </button>
        <button class="nav-link flex-fill" [class.active]="selectedFilter === 'user'" (click)="filterChannels('user')">
          Customers
        </button>
        <button class="nav-link flex-fill" [class.active]="selectedFilter === 'service_center'"
          (click)="filterChannels('service_center')">
          Admin Support
        </button>
      </div>
    </div>

    <div class="channels-list" style="height: calc(100vh - 200px); overflow-y: auto;">
      <div *ngFor="let channel of filteredChannels" class="channel-item p-3 border-bottom cursor-pointer"
        [class.bg-white]="selectedChannel?.id === channel.id" [class.bg-light]="selectedChannel?.id !== channel.id"
        [class.unread]="channel.unread_count && channel.unread_count > 0" (click)="selectChannel(channel.id)">

        <div class="d-flex align-items-start gap-3">
          <img [src]="getChannelAvatar(channel)" [alt]="channel.name || 'Channel'"
            (error)="handleAvatarError($event, channel)" class="rounded-circle"
            style="width: 45px; height: 45px; object-fit: cover;" #avatarImg
            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">

          <div class="channel-info flex-grow-1">
            <div class="d-flex justify-content-between align-items-start mb-1">
              <h6 class="channel-name mb-0 text-truncate" style="max-width: 200px;">
                {{ channel.name }}
              </h6>
              <div class="channel-status">
                <span *ngIf="channel.unread_count && channel.unread_count > 0" class="badge bg-danger rounded-pill">
                  {{ channel.unread_count }}
                </span>
              </div>
            </div>

            <!-- <div class="channel-details small text-muted mb-1 d-flex">
              <button class="btn btn-sm btn-outline-danger delete-btn ms-2"
                (click)="confirmDeleteChannel(channel.id, $event)" title="Delete Channel">
                Delete
              </button>
            </div> -->

            <div class="last-message-time small text-muted">
              <i class="bi bi-clock me-1"></i>
              {{ formatTime(channel.last_message_at) }}
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="filteredChannels.length === 0" class="text-center p-5 text-muted">
        <i class="bi bi-inbox fa-2x mb-3"></i>
        <p>No conversations found</p>
      </div>
    </div>
  </div>

  <!-- Chat Area -->
  <div class="chat-area flex-grow-1 d-flex flex-column">
    <div *ngIf="!selectedChannel"
      class="no-chat-selected d-flex flex-column align-items-center justify-content-center h-100 bg-light">
      <div class="text-center text-muted p-5">
        <i class="bi bi-chat fa-4x mb-4 opacity-50"></i>
        <h3 class="h4 mb-2">Select a conversation</h3>
        <p class="mb-4">Choose a conversation from the sidebar or start a new one</p>
        <div class="d-flex gap-3 justify-content-center">
          <button class="btn btn-outline-primary" (click)="startAdminChat()">
            <i class="bi bi-headset me-2"></i>Contact Admin Support
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="selectedChannel && selectedChannelData" class="chat-container d-flex flex-column h-100">
      <!-- Chat Header -->
      <div class="chat-header bg-white border-bottom p-3">
        <div class="d-flex justify-content-between align-items-center">
          <div class="chat-info">
            <h5 class="chat-title mb-1">
              <i [class]="getChannelIcon(selectedChannelData.type) + ' me-2 text-primary'"></i>
              {{ selectedChannelData.name }}
            </h5>
            <div class="chat-subtitle small text-muted">
              <span *ngIf="selectedChannelData.customer_info?.email" class="ms-2">
                <i class="bi bi-envelope me-1"></i>{{ selectedChannelData.customer_info?.email }}
              </span>
            </div>
          </div>
          <div class="chat-actions">
            <button class="btn btn-sm btn-outline-secondary" (click)="closeChat()" title="Close Chat">
              <i class="bi bi-x"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Messages Area -->
      <div class="messages-container flex-grow-1 p-4">
        <div *ngFor="let message of messages" class="message-wrapper mb-3"
          [class.text-end]="message.user?.id === currentUser?.id">

          <div class="message-bubble d-inline-block max-w-75">
            <div class="card border-0 shadow-sm" [class.bg-primary]="message.user?.id === currentUser?.id"
              [class.bg-light]="message.user?.id !== currentUser?.id">
              <div class="card-body p-3">
                <!-- Text content -->
                <div class="message-content mb-2" [class.text-white]="message.user?.id === currentUser?.id"
                  [class.text-dark]="message.user?.id !== currentUser?.id">
                  {{ message.text }}
                </div>

                <!-- Attachments -->
                <div *ngIf="message.attachments?.length" class="attachments-container">
                  <div *ngFor="let attachment of message.attachments" class="attachment-item">

                    <!-- Image attachments -->
                    <div *ngIf="isImageAttachment(attachment)" class="image-attachment">
                      <div class="image-container position-relative rounded border"
                        [class.border-primary]="message.user?.id === currentUser?.id"
                        [class.border-secondary]="message.user?.id !== currentUser?.id">
                        <img [src]="getAttachmentUrl(attachment)" [alt]="attachment.title || 'Image'"
                          class="img-fluid rounded" loading="lazy" (click)="openImageModal(attachment)" />
                        <div class="image-overlay" (click)="openImageModal(attachment)">
                          <i class="bi bi-zoom-in text-white"></i>
                        </div>
                      </div>
                      <div *ngIf="attachment.title" class="image-caption small text-muted mt-1 px-1">
                        {{ attachment.title }}
                      </div>
                    </div>

                    <!-- File attachments -->
                    <div *ngIf="!isImageAttachment(attachment)" class="file-attachment mt-2">
                      <div class="d-flex align-items-center p-3 rounded"
                        [class.bg-primary]="message.user?.id === currentUser?.id"
                        [class.bg-white]="message.user?.id !== currentUser?.id"
                        [class.text-white]="message.user?.id === currentUser?.id"
                        [class.border]="message.user?.id !== currentUser?.id">
                        <i class="bi bi-file-earmark-fill me-3"
                          [class.text-white]="message.user?.id === currentUser?.id"></i>
                        <div class="flex-grow-1">
                          <a [href]="getAttachmentUrl(attachment)" target="_blank" class="text-decoration-none d-block"
                            [class.text-white]="message.user?.id === currentUser?.id"
                            [class.text-dark]="message.user?.id !== currentUser?.id">
                            <strong>{{ attachment.title || 'Download file' }}</strong>
                          </a>
                          <div *ngIf="attachment.file_size" class="small mt-1"
                            [class.text-white-50]="message.user?.id === currentUser?.id"
                            [class.text-muted]="message.user?.id !== currentUser?.id">
                            {{ formatFileSize(attachment.file_size) }}
                          </div>
                        </div>
                        <i class="bi bi-download ms-2" [class.text-white]="message.user?.id === currentUser?.id"
                          [class.text-muted]="message.user?.id !== currentUser?.id"></i>
                      </div>
                    </div>

                  </div>
                </div>

                <div class="message-meta small mt-2" [class.text-white-50]="message.user?.id === currentUser?.id"
                  [class.text-muted]="message.user?.id !== currentUser?.id">
                  <span class="message-author fw-medium">{{ message.user?.name || 'Unknown' }}</span>
                  <span class="message-time ms-2">
                    <i class="bi bi-clock me-1"></i>
                    {{ formatMessageTime(message.created_at) }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Image Modal -->
        <div *ngIf="showImageModal && selectedImage" class="image-modal-backdrop" (click)="closeImageModal()">
          <div class="modal-container" (click)="$event.stopPropagation()">
            <div class="modal-content">
              <div class="modal-header">
                <h6 class="modal-title">Image Preview</h6>
                <button type="button" class="close-btn" (click)="closeImageModal()">
                  <i class="bi bi-x-lg"></i>
                </button>
              </div>
              <div class="modal-body">
                <img [src]="selectedImage" alt="Preview" class="modal-image" />
              </div>
              <div class="modal-footer">
                <button class="btn btn-sm btn-outline-light" (click)="closeImageModal()">
                  <i class="bi bi-x-circle me-1"></i>Close
                </button>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="isTyping"
          class="typing-indicator d-flex align-items-center text-muted p-3 bg-white rounded-3 shadow-sm">
          <div class="typing-dots me-2">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
          </div>
          <span>{{ isTyping === 'admin-support' ? 'Admin Support' : 'Customer' }} is typing...</span>
        </div>
      </div>

      <!-- Message Input -->
      <div class="message-input-container bg-white border-top p-3">
        <div class="input-wrapper d-flex gap-2 align-items-center">
          <input type="file" #fileInput hidden (change)="onFileSelected($event)" />
          <button class="btn btn-outline-secondary" title="Attach File" (click)="fileInput.click()">
            <i class="bi bi-paperclip"></i>
          </button>
          <input type="text" [(ngModel)]="newMessage" (keyup.enter)="sendMessage()" placeholder="Type your message..."
            class="form-control form-control-sm flex-grow-1" />
          <button class="btn btn-primary btn-sm px-2" (click)="sendMessage()" [disabled]="!newMessage.trim()">
            <i class="bi bi-send"></i>
          </button>
        </div>

        <!-- Quick responses -->
        <div class="quick-responses mt-3" *ngIf="showQuickResponses">
          <div class="d-flex align-items-center mb-2">
            <h6 class="small text-muted mb-0 me-3">Quick Responses:</h6>
            <button class="btn btn-sm btn-outline-success" (click)="addQuickResponse()">
              <i class="bi bi-plus-circle me-1"></i> Add Own Quick Response
            </button>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <button *ngFor="let response of quickResponses"
              class="quick-response-btn btn btn-outline-primary btn-sm text-start"
              (click)="useQuickResponse(response.text)">
              {{ response.text }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>