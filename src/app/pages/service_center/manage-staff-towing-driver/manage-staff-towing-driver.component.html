<div class="container">
  <h3 class="mb-3">
    <i class="bi bi-person-gear me-2 text-primary"></i>
    Manage Staff & Towing Drivers
  </h3>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <a class="nav-link" [class.active]="tab==='staff'" (click)="tab='staff'">
        <i class="bi bi-person-badge"></i> Staff
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="tab==='driver'" (click)="tab='driver'">
        <i class="bi bi-truck-front"></i> Towing Drivers
      </a>
    </li>
  </ul>

  <!-- Staff Section -->
  <div *ngIf="tab==='staff'">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-secondary text-white">Add Staff</div>
      <div class="card-body">
        <form [formGroup]="staffForm" class="row g-3" (ngSubmit)="addStaff()">
          <div class="col-md-3">
            <input class="form-control" placeholder="Name" formControlName="name">
          </div>
          <div class="col-md-3">
            <input class="form-control" placeholder="Email" formControlName="email">
          </div>
          <div class="col-md-2">
            <select class="form-select" formControlName="role">
              <option value="technician">Technician</option>
              <option value="reception">Reception</option>
              <option value="manager">Manager</option>
            </select>
          </div>
          <div class="col-md-2 text-end">
            <button class="btn btn-success" [disabled]="staffForm.invalid || loadingAddStaff">
              <ng-container *ngIf="loadingAddStaff; else normal">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Adding Staff...
              </ng-container>
              <ng-template #normal>
                <i class="bi bi-plus-circle"></i> Add
              </ng-template>
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header"><i class="bi bi-person-badge"></i> Staff List</div>
      <div class="card-body p-0">
        <table class="table table-hover mb-0">
          <thead class="table-secondary">
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Rejection Reason</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let s of staff">
              <td>{{ s.name }}</td>
              <td>{{ s.email }}</td>
              <td>{{ s.role }}</td>
              <td>
                <span class="badge" [ngClass]="{
                        'bg-success': s.status === 'approved',
                        'bg-danger': s.status === 'removed',
                      }">
                  {{ s.status}}
                </span>
              </td>
              <td>{{ s.rejectReason || '-' }}</td>
              <td>
                <div *ngIf="s.status === 'removed'" class="text-muted">-</div>
                <button *ngIf="s.status !== 'removed'" class="btn btn-danger" (click)="removeStaff(s.id)"><i
                    class="bi bi-trash"></i> Remove Staff</button>
              </td>
            </tr>
            <tr *ngIf="staff.length === 0">
              <td colspan="5" class="text-center text-muted">No staff added yet.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Driver Section -->
  <div *ngIf="tab==='driver'">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-secondary text-white">Add Towing Driver</div>
      <div class="card-body">
        <form [formGroup]="driverForm" class="row g-3" (ngSubmit)="addDriver()">
          <div class="col-md-3">
            <div class="label">Driver Name</div><input class="form-control" placeholder="Name" formControlName="name">
          </div>
          <div class="col-md-3">
            <div class="label">Driver Email</div><input class="form-control" placeholder="Email"
              formControlName="email">
          </div>
          <div class="col-md-3">
            <div class="label">Driver Phone Number</div><input class="form-control" placeholder="Phone Number"
              formControlName="phoneNo">
          </div>
          <div class="col-md-2">
            <div class="label">Towing Car Make</div><input class="form-control" placeholder="Make"
              formControlName="make">
          </div>
          <div class="col-md-2">
            <div class="label">Towing Car Model</div><input class="form-control" placeholder="Model"
              formControlName="model">
          </div>
          <div class="col-md-2">
            <div class="label">Towing Car Year</div><input class="form-control" placeholder="Year"
              formControlName="year">
          </div>
          <div class="col-md-2">
            <div class="label">Towing Car Plate</div><input class="form-control" placeholder="Plate"
              formControlName="carPlate">
          </div>

          <div class="alert alert-info mt-4" role="alert">
            <i class="bi bi-info-circle-fill"></i>
            Please upload clear images for verification. Ensure that the car plate, driving license, and the driver face
            are clearly visible. Blurry or unclear images may lead to rejection of the application. (Max size per image:
            100kb-150kb)
          </div>
          <!-- Vehicle Images -->
          <div class="col-12 mt-3">
            <div class="card shadow-sm border-0">
              <div class="card-header bg-light fw-semibold">
                <i class="bi bi-images me-2"></i> Vehicle Images <strong><i>(Front & Back) Car Plate should be
                    visible</i></strong>
              </div>
              <div class="card-body">
                <input type="file" class="form-control" (change)="uploadVehicleImage($event)" multiple>

                <div class="mt-3 d-flex gap-3 flex-wrap">
                  <div *ngFor="let img of uploadedVehicleImages; let i = index" class="position-relative">
                    <img [src]="img" width="140" height="100" class="rounded border shadow-sm object-fit-cover">

                    <div class="position-absolute top-0 end-0 d-flex flex-column m-1">
                      <button type="button" class="btn btn-sm btn-light mb-1 shadow-sm" (click)="viewVehicleImage(i)">
                        <i class="bi bi-zoom-in"></i>
                      </button>
                      <button type="button" class="btn btn-sm btn-danger shadow-sm" (click)="removeVehicleImage(i)">
                        <i class="bi bi-x-lg"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Driving License -->
          <div class="col-12 mt-3">
            <div class="card shadow-sm border-0">
              <div class="card-header bg-light fw-semibold">
                <i class="bi bi-card-image me-2"></i> Driving License <strong><i>Driving License should be
                    visible</i></strong>
              </div>
              <div class="card-body">
                <input type="file" class="form-control" (change)="uploadDrivingLicense($event)">
                <div class="mt-3 d-flex gap-3 flex-wrap">
                  <div *ngIf="uploadedDrivingLicense" class="mt-3 position-relative">
                    <img [src]="uploadedDrivingLicense" width="140" height="100"
                      class="rounded border shadow-sm object-fit-cover">

                    <div class="position-absolute top-0 end-0 d-flex flex-column m-1">
                      <button type="button" class="btn btn-sm btn-light mb-1 shadow-sm"
                        (click)="viewDrivingLicenseImage()">
                        <i class="bi bi-zoom-in"></i>
                      </button>
                      <button type="button" class="btn btn-sm btn-danger shadow-sm"
                        (click)="removeDrivingLicenseImage()">
                        <i class="bi bi-x-lg"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- driver latest picture -->
          <div class="col-12 mt-3">
            <div class="card shadow-sm border-0">
              <div class="card-header bg-light fw-semibold">
                <i class="bi bi-card-image me-2"></i> Driver Latest Picture <strong><i>Face should be clearly visible</i></strong>
              </div>
              <div class="card-body">
                <input type="file" class="form-control" (change)="uploadDriverImage($event)">
                <div class="mt-3 d-flex gap-3 flex-wrap">
                  <div *ngIf="uploadedDriverImage" class="mt-3 position-relative">
                    <img [src]="uploadedDriverImage" width="140" height="100" class="rounded border shadow-sm object-fit-cover">

                    <div class="position-absolute top-0 end-0 d-flex flex-column m-1">
                      <button type="button" class="btn btn-sm btn-light mb-1 shadow-sm" (click)="viewDriverImage()">
                        <i class="bi bi-zoom-in"></i>
                      </button>
                      <button type="button" class="btn btn-sm btn-danger shadow-sm" (click)="removeDriverImage()">
                        <i class="bi bi-x-lg"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal for image view -->
          <div class="modal fade show d-block" *ngIf="isImageModalOpen" tabindex="-1" role="dialog"
            style="background: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-dialog-centered modal-lg">
              <div class="modal-content border-0 shadow">
                <div class="modal-body text-center">
                  <img [src]="selectedImage" class="img-fluid rounded">
                </div>
                <div class="modal-footer border-0">
                  <button type="button" class="btn btn-secondary" (click)="closeImageModal()">
                    Close
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 text-end">
            <button class="btn btn-success" [disabled]="driverForm.invalid || loadingAddDriver">
              <ng-container *ngIf="loadingAddDriver; else normal">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Adding Driver...
              </ng-container>
              <ng-template #normal>
                <i class="bi bi-plus-circle"></i> Add Driver
              </ng-template>
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header"><i class="bi bi-car-front"></i> Towing Driver List</div>
      <div class="card-body p-0">
        <table class="table table-hover mb-0">
          <thead class="table-secondary">
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Phone no</th>
              <th>Status</th>
              <th>Rejection Reason</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let d of drivers">
              <td>{{ d.name }}</td>
              <td>{{ d.email }}</td>
              <td>{{ d.phoneNo }}</td>
              <td>
                <span class="badge" [ngClass]="{
                        'bg-success': d.status === 'approved',
                        'bg-danger': d.status === 'removed'
                      }">
                  {{ d.status || 'pending' }}
                </span>
              </td>
              <td>{{ d.rejectReason || '-' }}</td>
              <td>
                <div *ngIf="d.status === 'removed'" class="text-muted">-</div>
                <button *ngIf="d.status !== 'removed'" class="btn btn-danger" (click)="removeDriver(d.id)"><i
                    class="bi bi-trash"></i> Remove Driver</button>
              </td>
            </tr>
            <tr *ngIf="drivers.length === 0">
              <td colspan="5" class="text-center text-muted">No drivers added yet.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>