<div class="container py-4">
  <h3 class="mb-3">
    <i class="bi bi-gear-fill me-2 text-primary"></i>
    Service & Tier Setup
  </h3>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item"><a class="nav-link" [class.active]="tab==='service'" (click)="tab='service'">Service</a></li>
    <li class="nav-item"><a class="nav-link" [class.active]="tab==='tier'" (click)="tab='tier'">Tier</a></li>
  </ul>

  <!-- Service Management Tab -->
  <div *ngIf="tab==='service'">
    <h5 class="mb-3">Service Management</h5>

    <!-- category service and tier selection -->
    <div class="card shadow-sm mb-4">
      <div class="card-body row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label small text-muted">Category</label>
          <select class="form-select" [(ngModel)]="pick.categoryId" (change)="onPickCategory()">
            <option value="" disabled selected>Select Category</option>
            <ng-container *ngFor="let c of categories">
              <option [value]="c['id']">{{ c['name'] }}</option>
            </ng-container>
          </select>
        </div>

        <div class="col-md-5">
          <label class="form-label small text-muted">Service</label>
          <select class="form-select" [(ngModel)]="pick.serviceId" (change)="getServiceOfferDescription()">
            <option value="" disabled selected>Select Service</option>
            <ng-container *ngFor="let s of servicesByCategory[pick.categoryId]">
              <option [value]="s['id']">{{ s['name'] }}</option>
            </ng-container>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label small text-muted">Select Tier (optional)</label>
          <select class="form-select" [(ngModel)]="pick.tierId" (change)="applyTierToPricing()">
            <option value="" selected>None</option>
            <ng-container *ngFor="let t of serviceTiers">
              <option [value]="t.id">{{ t.tierName }}</option>
            </ng-container>
          </select>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-body row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label small text-muted">Service Description (default)</label>
          <textarea class="form-control" rows="3" placeholder="Enter Service Description" [value]="serviceDescription"
            [ngModel]="serviceDescription">
      </textarea>
        </div>
      </div>
    </div>


    <!-- Fitments for makes selection -->
    <div class="card shadow-sm mb-4">
      <div class="card-header fw-semibold">
        <i class="bi bi-car-front-fill me-2 text-primary"></i> Car Fitments
      </div>
      <div class="card-body">

        <!-- Make selection -->
        <div class="mb-2">
          <label class="form-label small text-muted">Select Makes</label>
          <div *ngIf="loading" class="d-flex align-items-center text-primary mb-2">
            <div class="spinner-border spinner-border-sm me-2"></div>
            <span>Loading makes...</span>
          </div>
          <div class="d-flex flex-wrap gap-3" *ngIf="!loading">
            <label class="form-check" *ngFor="let m of makes; trackBy: trackByMake">
              <input type="checkbox" class="form-check-input" [checked]="selectedMakesSvc.includes(m)"
                (change)="onMakeSvcToggle(m, $event)">
              <span class="form-check-label">{{ m }}</span>
            </label>
            <label class="form-check">
              <input type="checkbox" class="form-check-input" [(ngModel)]="requestOtherMakeSelectedInService">
              <span class="form-check-label">Other Brand</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Suggest Brand -->
    <div *ngIf="requestOtherMakeSelectedInService" class="card p-4 mt-3 mb-3 shadow-sm "
      style="border-left: 4px solid #f4b625;">
      <h6 class="mb-3 text-danger"><i class="bi bi-exclamation-circle"></i> Suggest a New Brand</h6>
      <input class="form-control mb-2 col-lg-4" [(ngModel)]="newMakeRequest"
        placeholder="Brand/Make name (e.g., Perodua, Proton)" />

      <!-- Add Models -->
      <div *ngFor="let model of newModels; let modelIndex = index" class="p-3 rounded mb-3 shadow-sm mt-2 card"
        style="border-left: 4px solid #01169f;">
        <h6>Model {{ modelIndex + 1 }}</h6>
        <input [(ngModel)]="model.name" class="form-control mb-2 col-lg-6"
          placeholder="Model name (e.g., Myvi, Ativa)" />

        <!-- Shared Attributes -->
        <div class="row g-2 mb-3">
          <div class="col-md-4">
            <label class="small text-muted">Select Fuel Type</label>
            <select class="form-select" [(ngModel)]="model.sharedFuel" (ngModelChange)="updateFitments(modelIndex)">
              <option value="" disabled selected>Fuel Type</option>
              <option *ngFor="let fuel of allFuelTypes" [value]="fuel">{{ fuel }}</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="small text-muted">Enter Displacement Volume (L)</label>
            <input (input)="onDisplacementChange($event, modelIndex)" class="form-control"
              placeholder="Displacement (e.g., 1.5)" (ngModelChange)="updateFitments(modelIndex)" />
          </div>
          <div class="col-md-4">
            <label class="small text-muted">Select Size Class</label>
            <select class="form-select" [(ngModel)]="model.sharedSizeClass"
              (ngModelChange)="updateFitments(modelIndex)">
              <option value="" disabled selected>Size Class</option>
              <option *ngFor="let size of allSizeClasses" [value]="size">{{ size }}</option>
            </select>
          </div>
        </div>

        <!-- Fitments -->
        <h6>Production Years</h6>
        <div *ngFor="let fitment of model.fitments; let fitmentIndex = index" class="border p-2 rounded mb-2">
          <div class="row g-2 align-items-center">
            <div class="col-md-3">
              <input [(ngModel)]="fitment.year" class="form-control" placeholder="Year (e.g., 2020)" />
            </div>
            <!-- auto fillup and is editable -->
            <div class="col-md-3">
              <select class="form-select" [(ngModel)]="fitment.sharedFuel" [value]="model.sharedFuel">
                <option value="" disabled selected>Fuel Type</option>
                <option *ngFor="let fuel of allFuelTypes" [value]="fuel">{{ fuel }}</option>
              </select>
            </div>
            <div class="col-md-3">
              <input (input)="onDisplacementChange($event, modelIndex, fitmentIndex)"
                [(ngModel)]="fitment.sharedDisplacement" class="form-control" placeholder="Displacement (e.g., 1.5)"
                [value]="model.sharedDisplacement" />
            </div>
            <div class="col-md-3 d-flex justify-content-between align-items-center">
              <select class="form-select" [(ngModel)]="fitment.sharedSizeClass" [value]="model.sharedSizeClass">
                <option value="" disabled selected>Size Class</option>
                <option *ngFor="let size of allSizeClasses" [value]="size">{{ size }}</option>
              </select>
            </div>
          </div>
          <div class="text-end mt-2">
            <button class="btn btn-sm btn-outline-danger" (click)="removeFitment(modelIndex, fitmentIndex)"><i
                class="bi bi-trash"></i>
              Remove Fitment</button>
          </div>
        </div>

        <div class="row p-3">
          <!-- Add/remove fitment -->
          <button class="btn btn-sm btn-outline-success me-3 col-lg-3" (click)="addFitment(modelIndex)"><i
              class="bi bi-plus-circle"></i>
            Add Fitment</button>
          <button class="btn btn-sm btn-outline-danger me-3 col-lg-3" (click)="removeModel(modelIndex)"><i
              class="bi bi-trash"></i>
            Remove Model</button>
        </div>
      </div>

      <div class="row p-3">
        <!-- Add Model -->
        <button class="btn btn-outline-primary me-3 col-lg-3 mb-2" (click)="addModel()"><i
            class="bi bi-plus-circle"></i>
          Add Model</button>

        <!-- Submit -->
        <button class="btn btn-primary me-3 col-lg-3 mb-2" (click)="submitNewVehicleAttributeRequest()">Submit Brand &
          Models</button>
      </div>
    </div>

    <!-- summary of selected fitmens-->
    <div *ngIf="selectedMakesSvc.length" class="mt-2 p-3">
      <div class="small text-muted mb-1">Selected scope:</div>
      <div class="d-flex flex-wrap gap-2">
        <span class="badge bg-secondary" *ngFor="let mk of selectedMakesSvc">{{ mk }}</span>
        <span class="badge bg-info" *ngFor="let pair of svcSelectedPairs()">
          {{ pair.make }} — {{ pair.model }}
        </span>
      </div>
    </div>

    <div class="card shadow-sm mb-3" *ngIf="selectedMakesSvc.length > 0">
      <div *ngFor="let make of selectedMakesSvc; trackBy: trackByMake" class="border rounded p-2 mb-3">
        <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
          <span>
            <i class="bi bi-grid-3x3-gap-fill me-2 text-primary"></i>{{ make }}
          </span>
          <button class="btn btn-sm btn-link" (click)="toggleMakePanel(make)">
            <span *ngIf="!expandMake[make]"><i class="bi bi-caret-right-fill"></i> Expand</span>
            <span *ngIf="expandMake[make]"><i class="bi bi-caret-down-fill"></i> Collapse</span>
          </button>
        </div>
        <div class="card-body" *ngIf="expandMake[make]">
          <!-- Search and Filtering -->
          <div class="row g-2 align-items-end mb-2">
            <div class="col-md-6">
              <label class="form-label small text-muted">Search models</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" [(ngModel)]="modelSearchSvc[make]" placeholder="e.g. Civic" />
              </div>
            </div>
            <div class="col-md-6 d-flex flex-wrap gap-2 justify-content-md-end">
              <button class="btn btn-sm btn-outline-primary" (click)="selectFilteredModelsSvc(make)">
                Select Filtered
              </button>
              <button class="btn btn-sm btn-outline-secondary" (click)="clearFilteredModelsSvc(make)">
                Clear Filtered
              </button>
            </div>
          </div>

          <div class="card p-3 shadow-sm rounded-3 mb-3">
            <div class="row g-3 align-items-center">

              <div class="col-12 col-md-6">
                <div class="d-flex flex-wrap align-items-center gap-2">
                  <span class="fw-semibold small text-muted">Years:</span>
                  <div *ngIf="!selectedMakesSvc.includes('other') || selectedMakesSvc[0] !== 'other'">
                    <button class="btn btn-sm btn-outline-secondary me-2"
                      (click)="applyYearPresetToMakeSvc(make,'latest5')">Latest 5</button>
                    <button class="btn btn-sm btn-outline-secondary"
                      (click)="applyYearPresetToMakeSvc(make,'all')">All</button>
                  </div>
                  <div *ngIf="selectedMakesSvc.includes('other')" class="text-muted small">
                    No Year Available
                  </div>
                </div>
              </div>

              <!-- Fuel Types -->
              <div class="col-12 col-md-6">
                <div class="d-flex flex-wrap align-items-center gap-2">
                  <span class="fw-semibold small text-muted">Fuel Types:</span>
                  <div *ngIf="getFilteredFuelTypesSvc(make).length === 0" class="text-muted small">No Fuel Types
                    Available</div>
                  <ng-container *ngFor="let fuel of getFilteredFuelTypesSvc(make)">
                    <button class="btn btn-sm btn-outline-primary" (click)="applyFuelTypeToMakeSvc(make, fuel)">
                      {{ fuel }}
                    </button>
                  </ng-container>
                </div>
              </div>

              <!-- Displacement -->
              <div class="col-12 col-md-6">
                <div class="d-flex flex-wrap align-items-center gap-2">
                  <span class="fw-semibold small text-muted">Displacement Volume:</span>
                  <div *ngIf="getFilteredDisplacementsSvc(make).length === 0" class="text-muted small">No Displacement
                    Available</div>
                  <ng-container *ngFor="let disp of getFilteredDisplacementsSvc(make)">
                    <button class="btn btn-sm btn-outline-success" (click)="applyDisplacementToMakeSvc(make, disp)">
                      {{ disp }} L
                    </button>
                  </ng-container>
                </div>
              </div>

              <!-- Size Class -->
              <div class="col-12 col-md-6">
                <div class="d-flex flex-wrap align-items-center gap-2">
                  <span class="fw-semibold small text-muted">Size Class:</span>
                  <div *ngIf="getFilteredSizeClassesSvc(make).length === 0" class="text-muted small">No Size Classes
                    Available</div>
                  <ng-container *ngFor="let size of getFilteredSizeClassesSvc(make)">
                    <button class="btn btn-sm btn-outline-warning" (click)="applySizeClassToMakeSvc(make, size)">
                      {{ size }}
                    </button>
                  </ng-container>
                </div>
              </div>
            </div>
          </div>

          <!-- Models -->
          <div class="d-flex flex-wrap gap-3">
            <label class="form-check" *ngFor="let model of getFilteredModelsSvc(make); trackBy: trackByModel">
              <input type="checkbox" class="form-check-input" [checked]="isSvcModelSelected(make, model)"
                (change)="toggleSvcModel(make, model)">
              <span class="form-check-label">{{ model }}</span>
            </label>
          </div>

          <!-- Selected models -->
          <div *ngFor="let model of selectedModelsSvc[make]" class="mt-2 p-2 bg-light rounded">
            <div class="small fw-semibold mb-1">{{ model }}</div>
            <div class="row g-2">
              <div class="col-md-3" *ngIf="yearsByModel[model]?.length">
                <div class="small text-muted mb-1">Years</div>
                <div class="scroll-box" style="max-height: 150px; overflow:auto;">
                  <label class="form-check small" *ngFor="let y of yearsByModel[model]; trackBy: trackByYear">
                    <input type="checkbox" class="form-check-input"
                      [checked]="(selectedYearsSvc[model]||[]).includes(y)"
                      (change)="toggleYearSvc(model, y, $event)" />
                    <span class="form-check-label">{{ y }}</span>
                  </label>
                </div>
              </div>

              <div class="col-md-3" *ngIf="fuelTypesByModel[model]?.length">
                <div class="small text-muted mb-1">Fuel</div>
                <label class="form-check small" *ngFor="let f of fuelTypesByModel[model]">
                  <input type="checkbox" class="form-check-input"
                    [checked]="(selectedFuelTypesSvc[model]||[]).includes(f)"
                    (change)="toggleFuelSvc(model, f, $event)" />
                  <span class="form-check-label">{{ f }}</span>
                </label>
              </div>

              <div class="col-md-3" *ngIf="displacementsByModel[model]?.length">
                <div class="small text-muted mb-1">Disp.</div>
                <label class="form-check small" *ngFor="let d of displacementsByModel[model]">
                  <input type="checkbox" class="form-check-input"
                    [checked]="(selectedDisplacementsSvc[model]||[]).includes(d)"
                    (change)="toggleDispSvc(model, d, $event)" />
                  <span class="form-check-label">{{ d }}</span>
                </label>
              </div>

              <div class="col-md-3" *ngIf="sizeClassesByModel[model]?.length">
                <div class="small text-muted mb-1">Size</div>
                <label class="form-check small" *ngFor="let s of sizeClassesByModel[model]">
                  <input type="checkbox" class="form-check-input"
                    [checked]="(selectedSizeClassesSvc[model]||[]).includes(s)"
                    (change)="toggleSizeSvc(model, s, $event)" />
                  <span class="form-check-label">{{ s }}</span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pricing & Save -->
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label small text-muted">Part Pricing Type</label>
            <select class="form-select" [(ngModel)]="pricing.partPriceType" (change)="onPartPricingTypeChange()">
              <option value="fixed">Fixed</option>
              <option value="range">Range</option>
              <option value="none">No Parts Fee</option>
            </select>
          </div>

          <div class="col-md-3" *ngIf="pricing.partPriceType==='fixed'">
            <label class="form-label small text-muted">Price (RM)</label>
            <input type="number" class="form-control" [(ngModel)]="pricing.partPrice" />
          </div>

          <div class="col-md-3" *ngIf="pricing.partPriceType==='range'">
            <label class="form-label small text-muted">Price Range (RM)</label>
            <div class="input-group">
              <input type="number" class="form-control" placeholder="Min" [(ngModel)]="pricing.partPriceMin" />
              <span class="input-group-text">—</span>
              <input type="number" class="form-control" placeholder="Max" [(ngModel)]="pricing.partPriceMax" />
            </div>
          </div>

          <div class="col-md-3" *ngIf="pricing.partPriceType==='none'">
            <label class="form-label small text-muted">No Parts Fee</label>
            <input type="text" class="form-control" value="RM 0" disabled />
          </div>
        </div>

        <div class="row g-3 align-items-end mt-2">
          <div class="col-md-3">
            <label class="form-label small text-muted">Labour Pricing Type</label>
            <select class="form-select" [(ngModel)]="pricing.labourPriceType" (change)="onLabourPricingTypeChange()">
              <option value="fixed">Fixed</option>
              <option value="range">Range</option>
              <option value="none">No Labour Fee</option>
            </select>
          </div>

          <div class="col-md-3" *ngIf="pricing.labourPriceType==='fixed'">
            <label class="form-label small text-muted">Price (RM)</label>
            <input type="number" class="form-control" [(ngModel)]="pricing.labourPrice" />
          </div>

          <div class="col-md-3" *ngIf="pricing.labourPriceType==='range'">
            <label class="form-label small text-muted">Price Range (RM)</label>
            <div class="input-group">
              <input type="number" class="form-control" placeholder="Min" [(ngModel)]="pricing.labourPriceMin" />
              <span class="input-group-text">—</span>
              <input type="number" class="form-control" placeholder="Max" [(ngModel)]="pricing.labourPriceMax" />
            </div>
          </div>

          <div class="col-md-3" *ngIf="pricing.labourPriceType==='none'">
            <label class="form-label small text-muted">No Labour Fee</label>
            <input type="text" class="form-control" value="RM 0" disabled />
          </div>

          <div class="col-md-3">
            <label class="form-label small text-muted">Duration (mins)</label>
            <input type="number" class="form-control" [(ngModel)]="pricing.duration" />
          </div>

          <div class="col-md-3 d-grid">
            <button class="btn btn-primary" (click)="saveOffer()">Save Offer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- alerts -->
    <div *ngIf="svcError" class="alert alert-danger mt-2">{{ svcError }}</div>
    <div *ngIf="svcInfo" class="alert alert-success mt-2">{{ svcInfo }}</div>

    <hr>
    <div class="container my-4">
      <h4 class="mb-3">Service Offers</h4>

      <div class="row g-2 align-items-center mb-3">
        <div class="col-auto">
          <label class="small text-muted">Search by services or make</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input class="form-control" placeholder="e.g, Consultation/Toyota" [(ngModel)]="searchInput"
              (ngModelChange)="applyFilters()" />
          </div>
        </div>

        <div class="col-auto ms-auto">
          <label class="small text-muted">Page size</label>
          <select class="form-select" [(ngModel)]="pageSize" (ngModelChange)="goToPage(1)">
            <option [value]="10">10</option>
            <option [value]="25">25</option>
            <option [value]="50">50</option>
          </select>
        </div>
      </div>

      <div class="row g-2 align-items-center mb-3">
        <div class="col-auto">
          <label class="small text-muted">Filter by Category</label>
          <select class="form-select" [(ngModel)]="filterCategory" (ngModelChange)="applyFilters()">
            <option value="">All Categories</option>
            <option *ngFor="let c of allCategories" [value]="c">{{ c }}</option>
          </select>
        </div>

        <div class="col-auto">
          <label class="small text-muted">Filter by Service</label>
          <select class="form-select" [(ngModel)]="filterService" (ngModelChange)="applyFilters()">
            <option value="">All Services</option>
            <option *ngFor="let s of allServices" [value]="s">{{ s }}</option>
          </select>
        </div>

        <div class="col-auto">
          <label class="small text-muted">Filter by Make</label>
          <select class="form-select" [(ngModel)]="filterMake" (ngModelChange)="applyFilters()">
            <option value="">All Makes</option>
            <option *ngFor="let m of allMakes" [value]="m">{{ m }}</option>
          </select>
        </div>

        <div class="col-auto">
          <label class="small text-muted">Filter by Year</label>
          <select class="form-select" [(ngModel)]="filterYear" (ngModelChange)="applyFilters()">
            <option value="">All Years</option>
            <option *ngFor="let y of allYears" [value]="y">{{ y }}</option>
          </select>
        </div>

        <div class="col-auto">
          <label class="small text-muted">Filter by Status Active</label>
          <select class="form-select" [(ngModel)]="filterStatus" (ngModelChange)="applyFilters()">
            <option value="">All Status</option>
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
      </div>


      <div *ngIf="loading" class="alert alert-info">Loading service offers...</div>
      <div *ngIf="error" class="alert alert-danger">{{ error }}</div>
      <div *ngIf="info" class="alert alert-success">{{ info }}</div>

      <div *ngIf="filteredOffers.length === 0 && !loading" class="text-muted">No service offer found.</div>

      <div class="row">
        <div class="col-12" *ngFor="let offer of pagedOffers">
          <div class="card mb-3 shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-start">
                <div class="flex-grow-1">
                  <div class="d-flex gap-3 align-items-baseline">
                    <h5 class="mb-0">{{ offer.service?.name || 'Unknown service' }}</h5>
                    <small class="text-muted">• {{ offer.category?.name || '-' }}</small>
                    <span class="badge ms-2" [ngClass]="offer.active ? 'bg-success' : 'bg-secondary'">
                      {{ offer.active ? 'Active' : 'Disabled' }}
                    </span>
                  </div>

                  <div class="mt-2">
                    <strong>Part Price:</strong> RM{{ formatPrice(offer, 'part') }} <br>
                    <strong>Labour Price:</strong> RM{{ formatPrice(offer, 'labour') }}
                    &nbsp; • &nbsp;
                    <strong>Duration:</strong> {{ offer.duration }} mins
                  </div>

                  <div class="mt-3">
                    <!-- Tier only -->
                    <div
                      *ngIf="offer.tier && (offer.tier.makes?.length || Object.keys(offer.tier.models || {}).length) && !(offer.carFitments?.makes?.length || Object.keys(offer.carFitments?.models || {}).length)"
                      class="p-2 rounded border bg-light mb-2">
                      <small class="fw-bold text-primary d-block mb-1">
                        Tier: {{ offer.tier.tierName || 'Tier' }}
                      </small>
                      <div class="small text-muted">
                        <b>Makes:</b> {{ (offer.tier.makes || []).join(', ') || '-' }}
                      </div>
                    </div>

                    <!-- Custom Fitment only -->
                    <div
                      *ngIf="offer.carFitments && (offer.carFitments.makes?.length || Object.keys(offer.carFitments.models || {}).length) && !(offer.tier?.makes?.length || Object.keys(offer.tier?.models || {}).length)"
                      class="p-2 rounded border bg-light mb-2">
                      <small class="fw-bold text-primary d-block mb-1">
                        Custom Fitment
                      </small>
                      <div class="small text-muted">
                        <b>Makes:</b> {{ (offer.carFitments.makes || []).join(', ') || '-' }}
                      </div>
                    </div>

                    <!-- Both Tier and Custom Fitment -->
                    <div
                      *ngIf="(offer.tier?.makes?.length || Object.keys(offer.tier?.models || {}).length) && (offer.carFitments?.makes?.length || Object.keys(offer.carFitments?.models || {}).length)"
                      class="p-2 rounded border bg-light">
                      <small class="fw-bold text-primary d-block mb-2">
                        Tier &amp; Custom Fitment
                      </small>
                      <div class="small text-muted mb-1">
                        <b>Tier Makes:</b> {{ (offer.tier?.makes || []).join(', ') || '-' }}
                      </div>
                      <div class="small text-muted">
                        <b>Custom Fitment Makes:</b> {{ (offer.carFitments?.makes || []).join(', ') || '-' }}
                      </div>
                    </div>
                  </div>



                  <!-- Expand button -->
                  <div class="mt-3">
                    <button class="btn btn-sm btn-link" (click)="toggleExpand(offer.serviceOfferId)">
                      <i
                        [class]="expanded[offer.serviceOfferId || offer.id] ? 'bi bi-caret-down-fill' : 'bi bi-caret-right-fill'"></i>
                      {{ expanded[offer.serviceOfferId || offer.id] ? 'Collapse details' : 'Show details' }}
                    </button>
                  </div>
                </div>

                <!-- Actions -->
                <div class="ms-4 text-end">
                  <div *ngIf="editingOfferId !== offer.serviceOfferId">
                    <button class="btn btn-sm btn-outline-primary mb-1 me-3" (click)="startEdit(offer)">Edit</button>
                    <button class="btn btn-sm btn-outline-warning mb-1 me-3" (click)="toggleActive(offer)">
                      {{ offer.active ? 'Disable' : 'Enable' }}
                    </button>
                    <button class="btn btn-sm btn-outline-danger mb-1 me-3" (click)="deleteOffer(offer)">Delete</button>
                  </div>

                  <!-- inline edit controls -->
                  <div *ngIf="editingOfferId === offer.serviceOfferId" class="text-start">
                    <!-- Toggle -->
                    <div class="mb-2">
                      <label class="form-label small mb-1"><i class="bi bi-tag"></i> Part Price Type</label>
                      <div class="d-flex gap-3">
                        <div class="form-check">
                          <input class="form-check-input" type="radio" id="fixedPrice-{{offer.serviceOfferId}}"
                            name="priceType-{{offer.serviceOfferId}}" [checked]="editBuffer.partPriceType === 'fixed'"
                            (change)="onPartPriceTypeChange('fixed')" />
                          <label class="form-check-label" for="fixedPrice-{{offer.serviceOfferId}}">
                            Fixed Price
                          </label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input" type="radio" id="rangePrice-{{offer.serviceOfferId}}"
                            name="priceType-{{offer.serviceOfferId}}" [checked]="editBuffer.partPriceType === 'range'"
                            (change)="onPartPriceTypeChange('range')" />
                          <label class="form-check-label" for="rangePrice-{{offer.serviceOfferId}}">
                            Price Range
                          </label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input" type="radio" id="nonePrice-{{offer.serviceOfferId}}"
                            name="priceType-{{offer.serviceOfferId}}" [checked]="editBuffer.partPriceType === 'none'"
                            (change)="onPartPriceTypeChange('none')" />
                          <label class="form-check-label" for="nonePrice-{{offer.serviceOfferId}}">
                            No Part Price
                          </label>
                        </div>
                      </div>
                    </div>

                    <!-- Fixed price input -->
                    <div class="mb-2">
                      <label class="form-label small mb-1 italic">Price (fixed)</label>
                      <input type="number" class="form-control form-control-sm" [(ngModel)]="editBuffer.partPrice"
                        placeholder="RM.." [disabled]="editBuffer.partPriceType !== 'fixed'" />
                    </div>

                    <!-- Range inputs -->
                    <div class="mb-2">
                      <label class="form-label small mb-1 italic">Price Min / Max</label>
                      <div class="d-flex gap-1">
                        <input type="number" class="form-control form-control-sm" [(ngModel)]="editBuffer.partPriceMin"
                          placeholder="Min" [disabled]="editBuffer.partPriceType !== 'range'" />
                        <input type="number" class="form-control form-control-sm" [(ngModel)]="editBuffer.partPriceMax"
                          placeholder="Max" [disabled]="editBuffer.partPriceType !== 'range'" />
                      </div>
                    </div>

                    <div class="mb-2">
                      <label class="form-label small mb-1"><i class="bi bi-tools"></i> Labour Price Type</label>
                      <div class="d-flex gap-3">
                        <div class="form-check">
                          <input class="form-check-input" type="radio" id="fixedPrice-{{offer.serviceOfferId}}"
                            name="priceType-{{offer.serviceOfferId}}" [checked]="editBuffer.labourPriceType === 'fixed'"
                            (change)="onLabourPriceTypeChange('fixed')" />
                          <label class="form-check-label" for="fixedPrice-{{offer.serviceOfferId}}">
                            Fixed Price
                          </label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input" type="radio" id="rangePrice-{{offer.serviceOfferId}}"
                            name="priceType-{{offer.serviceOfferId}}" [checked]="editBuffer.labourPriceType === 'range'"
                            (change)="onLabourPriceTypeChange('range')" />
                          <label class="form-check-label" for="rangePrice-{{offer.serviceOfferId}}">
                            Price Range
                          </label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input" type="radio" id="nonePrice-{{offer.serviceOfferId}}"
                            name="priceType-{{offer.serviceOfferId}}" [checked]="editBuffer.labourPriceType === 'none'"
                            (change)="onLabourPriceTypeChange('none')" />
                          <label class="form-check-label" for="nonePrice-{{offer.serviceOfferId}}">
                            No Labour Price
                          </label>
                        </div>
                      </div>
                    </div>

                    <!-- Fixed price input -->
                    <div class="mb-2">
                      <label class="form-label small mb-1 italic">Price (fixed)</label>
                      <input type="number" class="form-control form-control-sm" [(ngModel)]="editBuffer.labourPrice"
                        placeholder="RM.." [disabled]="editBuffer.labourPriceType !== 'fixed'" />
                    </div>

                    <!-- Range inputs -->
                    <div class="mb-2">
                      <label class="form-label small mb-1 italic">Price Min / Max</label>
                      <div class="d-flex gap-1">
                        <input type="number" class="form-control form-control-sm"
                          [(ngModel)]="editBuffer.labourPriceMin" placeholder="Min"
                          [disabled]="editBuffer.labourPriceType !== 'range'" />
                        <input type="number" class="form-control form-control-sm"
                          [(ngModel)]="editBuffer.labourPriceMax" placeholder="Max"
                          [disabled]="editBuffer.labourPriceType !== 'range'" />
                      </div>
                    </div>

                    <!-- Duration -->
                    <div class="mb-2">
                      <label class="form-label small mb-1 italic">Duration (mins)</label>
                      <input type="number" class="form-control form-control-sm" [(ngModel)]="editBuffer.duration" />
                    </div>

                    <div class="mb-2">
                      <label class="form-label small mb-1 italic">Service Description</label>
                      <textarea class="form-control form-control-sm" [(ngModel)]="editBuffer.serviceDescription"
                        rows="2"></textarea>
                    </div>

                    <!-- Buttons -->
                    <div class="d-flex gap-2">
                      <button class="btn btn-sm btn-success" (click)="saveEdit(offer)">Save</button>
                      <button class="btn btn-sm btn-secondary" (click)="cancelEdit()">Cancel</button>
                    </div>
                  </div>

                </div>
              </div>

              <!-- Expanded details -->
              <div *ngIf="expanded[offer.serviceOfferId || offer.id]" class="mt-3 border-top pt-3">

                <!-- Tier fitments -->
                <div *ngIf="offer.tier" class="mb-4">
                  <h6 class="fw-bold text-primary mb-2">
                    <i class="bi bi-diagram-3 me-1"></i> Tier Fitment (from Tier)
                  </h6>

                  <div *ngIf="showsSpecificSvcOfferFitmentsArr(offer.tier) as showAllSpecSvcOfferFit"
                    class="card shadow-sm border-0 mb-3">
                    <div class="card-body p-3 bg-light rounded">
                      <div class="row g-2">
                        <div class="col-md-6"><b>All Models:</b> {{ showAllSpecSvcOfferFit.allModelsSvcOffer.join(', ')
                          || '-' }}</div>
                        <div class="col-md-6"><b>All Years:</b> {{ showAllSpecSvcOfferFit.allYearsSvcOffer.join(', ') ||
                          '-' }}</div>
                        <div class="col-md-6"><b>All Fuel Types:</b> {{
                          showAllSpecSvcOfferFit.allFuelTypesSvcOffer.join(', ') || '-' }}</div>
                        <div class="col-md-6"><b>All Displacements:</b> {{
                          showAllSpecSvcOfferFit.allDisplacementsSvcOffer.join(', ') || '-' }}</div>
                        <div class="col-md-6"><b>All Size Classes:</b> {{
                          showAllSpecSvcOfferFit.allSizeClassesSvcOffer.join(', ') || '-' }}</div>
                      </div>
                    </div>
                  </div>

                  <div class="small ms-2">
                    <div *ngFor="let make of offer.tier.makes || []" class="mb-2">
                      <b class="text-dark">{{ make }}</b>
                      <div *ngFor="let model of offer.tier.models[make] || []" class="ms-3">
                        <i class="text-muted">{{ model }}</i>
                        <ul class="list-unstyled ms-3">
                          <li><b>Years:</b> {{ (offer.tier.years[model] || []).join(', ') || '-' }}</li>
                          <li><b>Fuel:</b> {{ (offer.tier.fuelTypes[model] || []).join(', ') || '-' }}</li>
                          <li><b>Displacements:</b> {{ (offer.tier.displacements[model] || []).join(', ') || '-' }}
                          </li>
                          <li><b>Sizes:</b> {{ (offer.tier.sizeClasses[model] || []).join(', ') || '-' }}</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Custom fitments -->
                <div
                  *ngIf="offer.carFitments && (offer.carFitments.makes?.length || Object.keys(offer.carFitments.models || {}).length)"
                  class="mb-4">
                  <h6 class="fw-bold text-secondary mb-2">
                    <i class="bi bi-wrench-adjustable-circle me-1"></i> Custom Fitments
                  </h6>

                  <div *ngIf="showsSpecificSvcOfferFitmentsArr(offer.carFitments) as showAllSpecSvcOfferFit"
                    class="card shadow-sm border-0 mb-3">
                    <div class="card-body p-3 bg-light rounded">
                      <div class="row g-2">
                        <div class="col-md-6"><b>All Models:</b> {{ showAllSpecSvcOfferFit.allModelsSvcOffer.join(', ')
                          || '-' }}</div>
                        <div class="col-md-6"><b>All Years:</b> {{ showAllSpecSvcOfferFit.allYearsSvcOffer.join(', ') ||
                          '-' }}</div>
                        <div class="col-md-6"><b>All Fuel Types:</b> {{
                          showAllSpecSvcOfferFit.allFuelTypesSvcOffer.join(', ') || '-' }}</div>
                        <div class="col-md-6"><b>All Displacements:</b> {{
                          showAllSpecSvcOfferFit.allDisplacementsSvcOffer.join(', ') || '-' }}</div>
                        <div class="col-md-6"><b>All Size Classes:</b> {{
                          showAllSpecSvcOfferFit.allSizeClassesSvcOffer.join(', ') || '-' }}</div>
                      </div>
                    </div>
                  </div>

                  <div class="small ms-2">
                    <div *ngFor="let make of offer.carFitments.makes || []" class="mb-2">
                      <b class="text-dark">{{ make }}</b>
                      <div *ngFor="let model of offer.carFitments.models[make] || []" class="ms-3">
                        <i class="text-muted">{{ model }}</i>
                        <ul class="list-unstyled ms-3">
                          <li><b>Years:</b> {{ (offer.carFitments.years[model] || []).join(', ') || '-' }}</li>
                          <li><b>Fuel:</b> {{ (offer.carFitments.fuelTypes[model] || []).join(', ') || '-' }}</li>
                          <li><b>Displacements:</b> {{ (offer.carFitments.displacements[model] || []).join(', ') ||
                            '-'
                            }}</li>
                          <li><b>Sizes:</b> {{ (offer.carFitments.sizeClasses[model] || []).join(', ') || '-' }}</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <nav *ngIf="filteredOffers.length > pageSize" class="mt-3">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <button class="page-link" (click)="goToPage(currentPage - 1)">Previous</button>
          </li>

          <li class="page-item" *ngFor="let p of [].constructor(totalPages); let i = index"
            [class.active]="currentPage === i + 1">
            <button class="page-link" (click)="goToPage(i + 1)">{{ i + 1 }}</button>
          </li>

          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <button class="page-link" (click)="goToPage(currentPage + 1)">Next</button>
          </li>
        </ul>
      </nav>
    </div>

  </div>

  <!-- Tier Management Tab -->
  <div *ngIf="tab==='tier'">
    <h5 class="mb-3">Tier Management</h5>

    <!-- Alerts -->
    <div *ngIf="errorMessage" class="alert alert-danger d-flex align-items-center me-2">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      {{ errorMessage }}
    </div>
    <div *ngIf="infoMessage" class="alert alert-success d-flex align-items-center">
      <i class="bi bi-check-circle-fill me-2"></i>
      {{ infoMessage }}
    </div>

    <!-- Tier Name -->
    <form [formGroup]="tierForm" class="card p-3 mb-4 shadow-sm">
      <div class="row g-3 align-items-center">
        <div class="col-md-6">
          <label class="form-label small fw-semibold">
            <i class="bi bi-tags-fill me-2 text-primary"></i>Tier Name
          </label>
          <input type="text" class="form-control" formControlName="tierName" placeholder="e.g. Sedan Tier A" />
        </div>
        <div class="col-md-3 mt-5">
          <button type="button" class="btn btn-success" (click)="saveTier()">
            <i class="bi bi-save me-2"></i> Save Tier
          </button>
        </div>
      </div>
    </form>

    <!-- Car Makes -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
        <span><i class="bi bi-car-front-fill me-2 text-primary"></i> Select Car Makes</span>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-primary" (click)="selectAllMakes()">Select All</button>
          <button class="btn btn-sm btn-outline-secondary" (click)="clearAllMakes()">Clear</button>
        </div>
      </div>

      <div class="card-body">
        <div class="mb-2">
          <div *ngIf="loading" class="d-flex align-items-center text-primary mb-2">
            <div class="spinner-border spinner-border-sm me-2"></div>
            <span>Loading makes...</span>
          </div>
          <div class="d-flex flex-wrap gap-3" *ngIf="!loading">
            <div *ngFor="let m of makes; trackBy: trackByMake" class="form-check">
              <input type="checkbox" class="form-check-input" [value]="m" [checked]="(selectedMakes || []).includes(m)"
                (change)="onMakeToggle(m, $event)" />
              <label class="form-check-label">{{ m }}</label>
            </div>
            <label class="form-check">
              <input type="checkbox" class="form-check-input" [(ngModel)]="requestOtherMakeSelectedInTier">
              <span class="form-check-label">Other Brand</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Suggest Brand -->
    <div *ngIf="requestOtherMakeSelectedInTier" class="card p-4 mt-3 mb-3 shadow-sm "
      style="border-left: 4px solid #f4b625;">
      <h6 class="mb-3 text-danger"><i class="bi bi-exclamation-circle"></i> Suggest a New Brand</h6>
      <input class="form-control mb-2 col-lg-4" [(ngModel)]="newMakeRequest"
        placeholder="Brand/Make name (e.g., Perodua, Proton)" />

      <!-- Add Models -->
      <div *ngFor="let model of newModels; let modelIndex = index" class="p-3 rounded mb-3 shadow-sm mt-2 card"
        style="border-left: 4px solid #01169f;">
        <h6>Model {{ modelIndex + 1 }}</h6>
        <input [(ngModel)]="model.name" class="form-control mb-2 col-lg-6"
          placeholder="Model name (e.g., Myvi, Ativa)" />

        <!-- Shared Attributes -->
        <div class="row g-2 mb-3">
          <div class="col-md-4">
            <select class="form-select" [(ngModel)]="model.sharedFuel" (ngModelChange)="updateFitments(modelIndex)">
              <option value="" disabled selected>Fuel Type</option>
              <option *ngFor="let fuel of allFuelTypes" [value]="fuel">{{ fuel }}</option>
            </select>
          </div>
          <div class="col-md-4">
            <input (input)="onDisplacementChange($event, modelIndex)" class="form-control"
              placeholder="Displacement (e.g., 1.5)" (ngModelChange)="updateFitments(modelIndex)" />
          </div>
          <div class="col-md-4">
            <select class="form-select" [(ngModel)]="model.sharedSizeClass"
              (ngModelChange)="updateFitments(modelIndex)">
              <option value="" disabled selected>Size Class</option>
              <option *ngFor="let size of allSizeClasses" [value]="size">{{ size }}</option>
            </select>
          </div>
        </div>

        <!-- Fitments -->
        <h6>Production Years</h6>
        <div *ngFor="let fitment of model.fitments; let fitmentIndex = index" class="border p-2 rounded mb-2">
          <div class="row g-2 align-items-center">
            <div class="col-md-3">
              <input [(ngModel)]="fitment.year" class="form-control" placeholder="Year (e.g., 2020)" />
            </div>
            <!-- Auto-fill and editable -->
            <div class="col-md-3">
              <select class="form-select" [(ngModel)]="fitment.sharedFuel" [value]="model.sharedFuel">
                <option value="" disabled selected>Fuel Type</option>
                <option *ngFor="let fuel of allFuelTypes" [value]="fuel">{{ fuel }}</option>
              </select>
            </div>
            <div class="col-md-3">
              <input (input)="onDisplacementChange($event, modelIndex, fitmentIndex)"
                [(ngModel)]="fitment.sharedDisplacement" class="form-control" placeholder="Displacement (e.g., 1.5)"
                [value]="model.sharedDisplacement" />
            </div>
            <div class="col-md-3 d-flex justify-content-between align-items-center">
              <select class="form-select" [(ngModel)]="fitment.sharedSizeClass" [value]="model.sharedSizeClass">
                <option value="" disabled selected>Size Class</option>
                <option *ngFor="let size of allSizeClasses" [value]="size">{{ size }}</option>
              </select>
            </div>
          </div>
          <div class="text-end mt-2">
            <button class="btn btn-sm btn-outline-danger" (click)="removeFitment(modelIndex, fitmentIndex)"><i
                class="bi bi-trash"></i>
              Remove Fitment</button>
          </div>
        </div>

        <div class="row p-3">
          <!-- Add/remove fitment -->
          <button class="btn btn-sm btn-outline-success me-3 col-lg-3" (click)="addFitment(modelIndex)"><i
              class="bi bi-plus-circle"></i>
            Add Fitment</button>
          <button class="btn btn-sm btn-outline-danger me-3 col-lg-3" (click)="removeModel(modelIndex)"><i
              class="bi bi-trash"></i>
            Remove Model</button>
        </div>
      </div>

      <div class="row p-3">
        <!-- Add Model -->
        <button class="btn btn-outline-primary me-3 col-lg-3 mb-2" (click)="addModel()"><i
            class="bi bi-plus-circle"></i>
          Add Model</button>

        <!-- Submit -->
        <button class="btn btn-primary me-3 col-lg-3 mb-2" (click)="submitNewVehicleAttributeRequest()">Submit Brand &
          Models</button>
      </div>
    </div>


    <!-- Models & Filters per Car Make -->
    <div *ngFor="let make of selectedMakes; trackBy: trackByMake" class="card mb-3 shadow-sm">
      <div class="card-header fw-bold d-flex justify-content-between align-items-center">
        <span>
          <i class="bi bi-grid-3x3-gap-fill me-2 text-info"></i> {{ make }}
        </span>
        <button class="btn btn-sm btn-link" (click)="toggleMakePanel(make)">
          <span *ngIf="!expandMake[make]"><i class="bi bi-caret-right-fill"></i> Expand</span>
          <span *ngIf="expandMake[make]"><i class="bi bi-caret-down-fill"></i> Collapse</span>
        </button>
      </div>

      <div class="card-body" *ngIf="expandMake[make]">
        <!-- Models toolbar -->
        <div class="row g-2 align-items-end mb-2">
          <div class="col-md-6">
            <label class="form-label small text-muted">Search models</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="text" class="form-control" [(ngModel)]="modelSearch[make]" placeholder="e.g. Civic" />
            </div>
          </div>
          <div class="col-md-6 d-flex flex-wrap gap-2 justify-content-md-end">
            <button class="btn btn-sm btn-outline-primary" (click)="selectFilteredModels(make)">
              Select Filtered
            </button>
            <button class="btn btn-sm btn-outline-secondary" (click)="clearFilteredModels(make)">
              Clear Filtered
            </button>
            <button class="btn btn-sm btn-outline-primary" (click)="selectAllModels(make)">
              Select All Models
            </button>
            <button class="btn btn-sm btn-outline-secondary" (click)="clearAllModels(make)">
              Clear Models
            </button>
          </div>
        </div>

        <!-- Brand-wide presets section buttons-->
        <div class="card p-3 shadow-sm rounded-3 mb-3">
          <div class="row g-3 align-items-center">

            <!-- Years -->
            <div class="col-12 col-md-6">
              <div class="d-flex flex-wrap align-items-center gap-2">
                <span class="fw-semibold small text-muted">Years:</span>
                <div *ngIf="!selectedMakes.includes('other')">
                  <button class="btn btn-sm btn-outline-dark me-2"
                    (click)="applyYearPresetToMake(make, 'latest5')">Latest
                    5</button>
                  <button class="btn btn-sm btn-outline-dark" (click)="applyYearPresetToMake(make, 'all')">All</button>
                </div>
                <div *ngIf="selectedMakes.includes('other')" class="text-muted small">
                  No Year Available
                </div>
              </div>
            </div>

            <!-- Fuel Types -->
            <div class="col-12 col-md-6">
              <div class="d-flex flex-wrap align-items-center gap-2">
                <span class="fw-semibold small text-muted">Fuel Types:</span>
                <div *ngIf="getFilteredFuelTypes(make).length === 0" class="text-muted small">No Fuel Types
                  Available</div>
                <ng-container *ngFor="let fuel of getFilteredFuelTypes(make)">
                  <button class="btn btn-sm btn-outline-primary" (click)="applyFuelTypeToMake(make, fuel)">
                    {{ fuel }}
                  </button>
                </ng-container>
              </div>
            </div>

            <!-- Displacement -->
            <div class="col-12 col-md-6">
              <div class="d-flex flex-wrap align-items-center gap-2">
                <span class="fw-semibold small text-muted">Displacement Volume:</span>
                <div *ngIf="getFilteredDisplacements(make).length === 0" class="text-muted small">No Displacement
                  Available</div>
                <ng-container *ngFor="let disp of getFilteredDisplacements(make)">
                  <button class="btn btn-sm btn-outline-success" (click)="applyDisplacementToMake(make, disp)">
                    {{ disp }} L
                  </button>
                </ng-container>
              </div>
            </div>

            <!-- Size Class -->
            <div class="col-12 col-md-6">
              <div class="d-flex flex-wrap align-items-center gap-2">
                <span class="fw-semibold small text-muted">Size Class:</span>
                <div *ngIf="getFilteredSizeClasses(make).length === 0" class="text-muted small">No Size Classes
                  Available</div>
                <ng-container *ngFor="let size of getFilteredSizeClasses(make)">
                  <button class="btn btn-sm btn-outline-warning" (click)="applySizeClassToMake(make, size)">
                    {{ size }}
                  </button>
                </ng-container>
              </div>
            </div>

          </div>
        </div>


        <!-- Models list -->
        <div class="d-flex flex-wrap gap-3 mb-3">
          <div *ngFor="let model of getFilteredModels(make); trackBy: trackByModel" class="form-check">
            <input type="checkbox" class="form-check-input" [checked]="isModelSelected(make, model)"
              (change)="toggleModel(make, model)">
            <label class="form-check-label">{{ model }}</label>
          </div>
        </div>

        <!-- Filters per Model -->
        <div *ngFor="let model of selectedModels[make]; trackBy: trackByModel" class="border rounded p-2 mb-2 bg-light">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="m-0">
              <i class="bi bi-sliders me-2 text-secondary"></i> {{ model }}
            </h6>
            <button class="btn btn-sm btn-link" (click)="toggleModelPanel(model)">
              <span *ngIf="!expandModel[model]"><i class="bi bi-caret-right-fill"></i> Show Filters</span>
              <span *ngIf="expandModel[model]"><i class="bi bi-caret-down-fill"></i> Hide Filters</span>
            </button>
          </div>

          <div *ngIf="expandModel[model]" class="mt-2">
            <div class="row">
              <!-- Years -->
              <div class="col-md-3" *ngIf="yearsByModel[model]">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <strong><i class="bi bi-calendar3 me-1"></i> Years</strong>
                </div>

                <div class="d-flex flex-wrap gap-2 mb-2">
                  <button class="btn btn-sm btn-outline-primary" (click)="applyYearPreset(model, 'latest5')">Latest
                    5</button>
                  <button class="btn btn-sm btn-outline-primary" (click)="applyYearPreset(model, 'all')">All</button>
                  <button class="btn btn-sm btn-outline-secondary" (click)="clearYears(model)">Clear</button>
                </div>

                <div class="scroll-box" style="max-height: 160px; overflow:auto;">
                  <div *ngFor="let y of yearsByModel[model]; trackBy: trackByYear" class="form-check">
                    <input type="checkbox" class="form-check-input" [checked]="(selectedYears[model] || []).includes(y)"
                      (change)="toggleYear(model, y, $event)" />
                    <label class="form-check-label">{{ y }}</label>
                  </div>
                </div>
              </div>

              <!-- Fuel -->
              <div class="col-md-3" *ngIf="fuelTypesByModel[model]">
                <strong><i class="bi bi-fuel-pump me-1"></i> Fuel</strong>
                <div *ngFor="let f of fuelTypesByModel[model]" class="form-check">
                  <input type="checkbox" class="form-check-input"
                    [checked]="(selectedFuelTypes[model] || []).includes(f)" [value]="f"
                    (change)="toggleFuel(model, f, $event)" />
                  <label class="form-check-label">{{ f }}</label>
                </div>
              </div>

              <!-- Displacements -->
              <div class="col-md-3" *ngIf="displacementsByModel[model]">
                <strong><i class="bi bi-speedometer2 me-1"></i> Displacement</strong>
                <div *ngFor="let d of displacementsByModel[model]" class="form-check">
                  <input type="checkbox" class="form-check-input"
                    [checked]="(selectedDisplacements[model] || []).includes(d)" [value]="d"
                    (change)="toggleDisplacement(model, d, $event)" />
                  <label class="form-check-label">{{ d }}</label>
                </div>
              </div>

              <!-- Sizes -->
              <div class="col-md-3" *ngIf="sizeClassesByModel[model]">
                <strong><i class="bi bi-arrows-fullscreen me-1"></i> Size</strong>
                <div *ngFor="let s of sizeClassesByModel[model]" class="form-check">
                  <input type="checkbox" class="form-check-input"
                    [checked]="(selectedSizeClasses[model] || []).includes(s)" [value]="s"
                    (change)="toggleSize(model, s, $event)" />
                  <label class="form-check-label">{{ s }}</label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Saved tiers -->
    <div class="row g-3 mt-4">
      <div class="col-12 col-md-6 col-lg-4" *ngFor="let t of savedTiers">
        <div class="card h-100 shadow-sm border-0">
          <div class="card-header bg-dark text-white fw-bold d-flex justify-content-between align-items-center">
            <span><i class="bi bi-layers me-2"></i>{{ t.tierName }}</span>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-light" (click)="duplicateTier(t)">
                <i class="bi bi-files"></i> Duplicate
              </button>
              <button class="btn btn-sm btn-outline-light" (click)="openDetails(t)">
                <i class="bi bi-eye"></i>
              </button>
            </div>
          </div>

          <div class="card-body">
            <p class="fw-semibold text-secondary">Makes:
              <span class="badge bg-secondary">{{ t.makes?.join(', ') }}</span>
            </p>

            <p class="fw-semibold text-info">Years Supported:
              <span class="badge bg-info">{{ getYearSummary(t.years) }}</span>
            </p>
            <div class="align-items-end">
              <button class="btn btn-sm btn-outline-danger me-2" (click)="deleteTier(t)"><i
                  class="bi bi-trash"></i></button>
              <button class="btn btn-sm btn-outline-primary" (click)="editTier(t)"><i class="bi bi-pencil"></i></button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title">
          <i class="bi bi-info-circle me-2"></i>Tier: {{ selectedTier?.tierName }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <table class="table table-bordered table-striped">
          <tbody>
            <tr>
              <th>Makes</th>
              <td>{{ selectedTier?.makes?.join(', ') }}</td>
            </tr>
            <tr>
              <th>Models</th>
              <td>
                <div *ngFor="let make of (selectedTier?.models | keyvalue)">
                  <strong>{{ make.key }}:</strong> {{ formatValues(make.value) }}
                </div>
              </td>
            </tr>
            <tr>
              <th>Years</th>
              <td>
                <div *ngFor="let yr of (selectedTier?.years | keyvalue)">
                  <strong>{{ yr.key }}:</strong> {{ formatValues(yr.value) }}
                </div>
              </td>
            </tr>
            <tr>
              <th>Fuel Types</th>
              <td>
                <div *ngFor="let fuel of (selectedTier?.fuelTypes | keyvalue)">
                  <strong>{{ fuel.key }}:</strong> {{ formatValues(fuel.value) }}
                </div>
              </td>
            </tr>
            <tr>
              <th>Displacements</th>
              <td>
                <div *ngFor="let d of (selectedTier?.displacements | keyvalue)">
                  <strong>{{ d.key }}:</strong> {{ formatValues(d.value) }} L
                </div>
              </td>
            </tr>
            <tr>
              <th>Size Classes</th>
              <td>
                <div *ngFor="let s of (selectedTier?.sizeClasses | keyvalue)">
                  <strong>{{ s.key }}:</strong> {{ formatValues(s.value) }}
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>