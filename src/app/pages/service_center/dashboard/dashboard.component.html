<div class="container">
  <h3 class="mb-4" style="color:#1F2A44;">Service Center Dashboard</h3>

  <div *ngIf="loading" class="text-center py-5">
    <span class="spinner-border spinner-border-sm me-2"></span> Loading dashboard...
  </div>

  <ng-container *ngIf="!loading">

    <!-- Service Appointments -->
    <h4 class="mt-3 mb-2 text-muted">Service Appointments</h4>
    <div class="row g-3">
      <div *ngFor="let stat of serviceStats" class="col-md-2">
        <div class="card shadow-sm border-0 h-100 text-center p-3 hover-card">
          <i [class]="stat.icon + ' fs-1 mb-2'" style="color:#FF6B00;"></i>
          <h6 class="fw-semibold small">{{ stat.label }}</h6>
          <h3 class="fw-bold">{{ stat.value }}</h3>
        </div>
      </div>
    </div>

    <!-- Towing Requests -->
    <h4 class="mt-4 mb-2 text-muted">Towing Requests</h4>
    <div class="row g-3">
      <div *ngFor="let stat of towingStats" class="col-md-2">
        <div class="card shadow-sm border-0 h-100 text-center p-3 hover-card">
          <i [class]="stat.icon + ' fs-1 mb-2'" style="color:#28A745;"></i>
          <h6 class="fw-semibold small">{{ stat.label }}</h6>
          <h3 class="fw-bold">{{ stat.value }}</h3>
        </div>
      </div>
    </div>

    <!-- Today's Bookings -->
    <div class="card shadow-sm mt-4">
      <div class="card-header bg-light">
        <h6 class="card-title mb-0">
          <i class="bi bi-calendar-day me-2"></i>Today's Bookings
          <span class="badge bg-primary ms-2">{{ todayBookings.length }}</span>
        </h6>
      </div>
      <div class="card-body p-0">
        <div *ngIf="todayBookings.length === 0" class="p-4 text-center text-muted">
          <i class="bi bi-calendar-x display-6"></i>
          <p class="mt-2 mb-0">No bookings for today.</p>
        </div>
        <div *ngIf="todayBookings.length > 0" class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th width="80">Type</th>
                <th width="150">Customer</th>
                <th width="180">Vehicle</th>
                <th width="120">Scheduled Time</th>
                <th width="150">Assignment</th>
                <th width="100">Status</th>
                <th width="120">Details</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let booking of todayBookings" [class.table-warning]="booking.status === 'pending'"
                [class.table-info]="booking.status === 'confirmed' || booking.status === 'accepted'"
                [class.table-primary]="booking.status === 'assigned' || booking.status === 'dispatched'"
                [class.table-orange]="booking.status === 'in_progress' || booking.status === 'ongoing'">
                <td>
                  <span class="badge" [ngClass]="{
                    'bg-primary': booking.type === 'service',
                    'bg-info': booking.type === 'towing'
                  }">
                    <i [class]="booking.type === 'service' ? 'bi bi-wrench me-1' : 'bi bi-truck me-1'"></i>
                    {{ booking.type | titlecase }}
                  </span>
                </td>
                <td>
                  <div class="fw-medium">{{ booking.customer?.name || 'N/A' }}</div>
                  <small class="text-muted">{{ booking.customer?.phone || 'No phone' }}</small>
                </td>
                <td>
                  <div class="fw-medium">{{ getVehicleDisplay(booking) }}</div>
                  <small *ngIf="booking.type === 'towing'" class="text-muted">
                    {{ booking.towingType || 'General Towing' }}
                  </small>
                </td>
                <td>
                  <div class="fw-medium">{{ getDisplayTime(booking) }}</div>
                  <small *ngIf="booking.type === 'service'" class="text-muted">
                    {{ booking.scheduledDate?.toDate() | date:'MMM d' }}
                  </small>
                </td>
                <td>
                  <div class="small">{{ getAssignmentInfo(booking) }}</div>
                  <small *ngIf="booking.type === 'towing' && booking.location" class="text-muted">
                    {{ booking.location.address }}
                  </small>
                </td>
                <td>
                  <span class="badge" [ngClass]="getStatusBadgeClass(booking.status)">
                    {{ booking.status | titlecase }}
                  </span>
                </td>
                <td>
                  <small *ngIf="booking.type === 'service'" class="text-muted">
                    <span *ngIf="booking.services?.length">
                      {{ booking.services.length }} service(s)
                    </span>
                    <span *ngIf="booking.packages?.length">
                      + {{ booking.packages.length }} package(s)
                    </span>
                  </small>
                  <small *ngIf="booking.type === 'towing'" class="text-muted">
                    {{ booking.towingType || 'General' }}
                  </small>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </ng-container>

  <div class="timeline-container">
    <div class="controls">
      <div class="date-navigation">
        <button (click)="previousPeriod()" [disabled]="loading"><i class="bi bi-chevron-left"></i></button>
        <button (click)="goToToday()" [disabled]="loading">Today</button>
        <button (click)="nextPeriod()" [disabled]="loading"><i class="bi bi-chevron-right"></i></button>

        <span class="current-period">
          {{ currentStartDate.value | date:'mediumDate' }}
          -
          {{ getDateRange(selectedDateRange.value, currentStartDate.value)[getDateRange(selectedDateRange.value,
          currentStartDate.value).length - 1] | date:'mediumDate' }}
        </span>

        <span class="operating-hours-info" *ngIf="overallStartTime && overallEndTime">
          Operating Hours: {{ overallStartTime }} - {{ overallEndTime }}
        </span>
      </div>

      <div class="view-options">
        <button [class.active]="selectedDateRange.value === 'week'" (click)="setDateRange('week')" [disabled]="loading">
          Week
        </button>
        <button [class.active]="selectedDateRange.value === 'month'" (click)="setDateRange('month')"
          [disabled]="loading">
          Month
        </button>
        <button [class.active]="selectedDateRange.value === 'year'" (click)="setDateRange('year')" [disabled]="loading">
          Year
        </button>
      </div>
      
    </div>

    <div *ngIf="loading" class="loading">
      Loading timeline...
    </div>

    <!-- Timeline Table -->
    <div *ngIf="!loading" class="timeline-table">
      <table>
        <thead>
          <tr>
            <th class="time-header">Time</th>
            <th *ngFor="let day of schedule" [class.today]="day.isToday" [class.past]="day.isPast"
              [class.closed]="!day.operatingHours" class="day-header">
              <div class="day-name">{{ day.dayName }}</div>
              <div class="date">{{ day.date | date:'MMM d' }}</div>
              <div class="day-operating-hours" *ngIf="day.operatingHours">
                {{ day.operatingHours.open }} - {{ day.operatingHours.close }}
              </div>
              <div class="day-closed" *ngIf="!day.operatingHours">
                Closed
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let timeSlot of getUniqueTimeSlots()">
            <tr>
              <td class="time-slot-header">{{ timeSlot }}</td>
              <td *ngFor="let day of schedule" class="time-slot-cell"
                [class.available]="getSlotForDayAndTime(day, timeSlot)?.isAvailable"
                [class.booked]="(getSlotForDayAndTime(day, timeSlot)?.bookings?.length || 0) > 0"
                [class.non-operating]="!getSlotForDayAndTime(day, timeSlot)?.isOperatingHour"
                [class.multiple-bookings]="(getSlotForDayAndTime(day, timeSlot)?.bookings?.length || 0) > 1">

                <!-- Show multiple bookings if they exist -->
                <div *ngIf="(getSlotForDayAndTime(day, timeSlot)?.bookings?.length || 0) > 0"
                  class="booking-info-container">
                  <div *ngFor="let booking of getSlotForDayAndTime(day, timeSlot)?.bookings; let i = index"
                    class="booking-info" [class]="'booking-status-' + booking.status + ' booking-index-' + (i % 5)"
                    [title]="getBookingTooltip(booking)">
                    <div class="booking-details">
                      <div class="booking-header">
                        <span class="vehicle-info">
                          {{ getVehicleShortDisplay(booking) }}
                        </span>
                        <span class="booking-status-badge" [ngClass]="getStatusBadgeClass(booking.status)">
                          {{ getStatusShortDisplay(booking.status) }}
                        </span>
                      </div>
                      <div class="booking-meta">
                        <span class="bay-info" *ngIf="booking.bayId">
                          <i class="bi bi-geo-fill"></i> {{ getBayName(booking.bayId) }}
                        </span>
                        <span class="duration-info" *ngIf="booking.estimatedDuration">
                          <i class="bi bi-clock"></i> {{ booking.estimatedDuration }}m
                        </span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Show available bays count when slot is available -->
                <div *ngIf="getSlotForDayAndTime(day, timeSlot)?.isOperatingHour && 
                    (getSlotForDayAndTime(day, timeSlot)?.bookings?.length || 0) === 0" class="available-label">
                  <div>Available</div>
                  <small class="available-bays-count">
                    {{ getAvailableBaysCountForSlot(day, timeSlot) }}/{{ bays.length }} bays
                  </small>
                </div>

                <div *ngIf="!getSlotForDayAndTime(day, timeSlot)?.isOperatingHour && day.operatingHours"
                  class="non-operating-label">
                  -
                </div>

                <div *ngIf="!day.operatingHours" class="closed-label">
                  Closed
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>

    <div class="legend">
      <div class="legend-item">
        <div class="color-box available"></div>
        <span>Available</span>
      </div>
      <div class="legend-item">
        <div class="color-box booked"></div>
        <span>Booked</span>
      </div>
      <div class="legend-item">
        <div class="color-box non-operating"></div>
        <span>Closed/Non-operating</span>
      </div>
    </div>
  </div>
</div>