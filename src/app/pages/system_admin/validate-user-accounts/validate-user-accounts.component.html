<div class="container mt-4">
  <h3 class="mb-4 fw-bold">
    <span class=" text-primary"><i class="bi bi-person-circle"></i></span> Car Owner Account Validation
  </h3>
  <hr>
  <!-- Tabs -->
  <ul class="nav nav-pills mb-4">
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab==='pending'" (click)="activeTab='pending'">
        Pending <span class="badge bg-warning text-dark">{{ pendingUsers.length }}</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab==='approved'" (click)="activeTab='approved'">
        Approved <span class="badge bg-success">{{ approvedUsers.length }}</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab==='rejected'" (click)="activeTab='rejected'">
        Rejected <span class="badge bg-danger">{{ rejectedUsers.length }}</span>
      </a>
    </li>
  </ul>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center py-5">
    <span class="spinner-border spinner-border-sm text-primary"></span> Loading Car Owner Accounts...
  </div>

  <!-- Table -->
  <div *ngIf="!loading">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-secondary">
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Vehicle Details</th>
          <th>Plate Number</th>
          <th>VIN</th>
          <th>Status</th>
          <th>Documents</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of getUsersByTab()">
          <td class="fw-semibold">{{ user.name }}</td>
          <td>{{ user.email }}</td>
          <td>
            <strong>{{ user.vehicles[0]?.make }} {{ user.vehicles[0]?.model }}</strong><br>
            <small class="text-muted">
              Year: {{ user.vehicles[0]?.year }} |
              Fuel: {{ user.vehicles[0]?.fuelType || 'N/A' }} |
              Engine: {{ user.vehicles[0]?.displacement || 'N/A' }}
            </small>
          </td>
          <td>{{ user.vehicles[0]?.plateNumber }}</td>
          <td><code>{{ user.vehicles[0]?.vin || 'N/A' }}</code></td>
          <td>
            <span class="badge" [ngClass]="{
                'bg-warning text-dark': user.verification?.status==='pending',
                'bg-success': user.verification?.status==='approved',
                'bg-danger': user.verification?.status==='rejected'
              }">
              {{ user.verification?.status | titlecase }}
            </span>
            <ng-container *ngIf="user.verification?.status==='rejected'">
              <br><small class="text-muted">Reason: {{ user.verification?.rejectionReason }}</small>
            </ng-container>
          </td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-2"
              (click)="openPreview(user.documents?.icUrl, user.documents?.icIv, user.documents?.icType, 'IC Card', user.name)">IC</button>
            <button class="btn btn-sm btn-outline-secondary me-2"
              (click)="openPreview(user.documents?.selfieUrl, user.documents?.selfieIv, user.documents?.selfieType, 'Selfie', user.name)">
              Selfie
            </button>
            <button class="btn btn-sm btn-outline-info me-2"
              (click)="openPreview(user.vehicles[0]?.vocUrl, user.vehicles[0]?.vocIv, user.vehicles[0]?.vocType, 'VOC', user.vehicles[0]?.vin)">VOC</button>
          </td>
          <td>
            <ng-container *ngIf="user.verification?.status==='pending'">
              <button class="btn btn-sm btn-success me-1" (click)="approveUserAccount(user, user.email)">
                <i class="bi bi-check-circle"></i>
              </button>
              <button class="btn btn-sm btn-danger" (click)="openRejectionModal(user)">
                <i class="bi bi-x-circle"></i>
              </button>
            </ng-container>
            <ng-container *ngIf="user.verification?.status==='rejected'">
            </ng-container>
          </td>
        </tr>
      </tbody>
    </table>
    <div *ngIf="getUsersByTab().length === 0" class="text-center py-5">
      <i class="bi bi-person-circle text-muted" style="font-size: 3rem;"></i>
      <p class="text-muted mt-3">No user accounts found for this category.</p>
    </div>
  </div>

  <!-- Modal Preview -->
  <div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ previewTitle }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="fw-semibold">{{ carOwnerDetails }}</p>
          <div class="text-center">
            <img [src]="previewUrl" class="img-fluid rounded shadow" alt="Preview" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rejection Modal -->
  <div class="modal fade" id="rejectionReasonModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Rejection Feedback</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Please provide a reason for rejecting <strong>{{ selectedUser?.name }}</strong>'s account:</p>
          <textarea [(ngModel)]="rejectionReason" class="form-control" rows="3"
            placeholder="E.g. IC is blurry..."></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-danger" (click)="confirmRejection()">Confirm Reject</button>
        </div>
      </div>
    </div>
  </div>
</div>